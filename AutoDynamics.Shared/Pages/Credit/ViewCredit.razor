@page "/credit/details"
@using AutoDynamics.Shared.Modals
@using AutoDynamics.Shared.Services
@inject IDatabaseHandler DatabaseHandler
@inject ICurrentData CurrentData
@inject NavigationManager Navigation

<div class="container mt-4">
    <h2 class="text-center mb-4">Credit Record</h2> <!-- Title Added -->

    <div class="col-md-12 mb-4">
        <input type="text" @oninput="(e)=>{FilterRecord(e);}" class="form-control" placeholder="Search by Customer Id, Name, Contact" />
    </div>
    <!-- Sivakasi Branch Table -->
    @if (showSivakasi)
    {
        <div class="col-md-12 mb-4">
            <div class="card shadow-lg">
                <div class="d-flex justify-content-between align-items-center card-header bg-primary text-white">
                    <h5 class="mb-0">Sivakasi Branch</h5>
                    <h5>Total Amount = @sivakasiCreditTotal</h5>
                </div>
                <div class="card-body">
                    @if (filteredSivakasiRecords.Any())
                    {
                        int sno = 1;
                        <table class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>S. No.</th>
                                    <th>Bill No</th>
                                    <th>Branch</th>
                                    <th>Customer Name</th>
                                    <th>Customer Mobile</th>
                                    <th>Credit Amount</th>
                                    <th>Paid Amount</th>
                                    <th>Remaining Balance</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in filteredSivakasiRecords)
                                {
                                    <tr style="cursor:pointer" @onclick="()=> CreditSelect(record.Customer)">
                                        <td>@(sno++)</td>
                                        <td>@record.BillNo</td>
                                        <td>@record.Branch</td>
                                        <td>@record.Customer.Name</td>
                                        <td>@record.Customer.Contact</td>
                                        <td>@record.CreditAmount</td>
                                        <td>@record.PaidAmount</td>
                                        <td>@record.RemainingBalance</td>
                                        <td>@record.DueDate</td>
                                        <td>@record.Status</td>
                                        <td>@record.CreatedAt</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center">No records for Sivakasi.</p>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Bypass Branch Table -->
    @if (showByPass)
    {
        <div class="col-md-12 mb-4">
            <div class="card shadow-lg">
                <div class="d-flex justify-content-between align-items-center card-header bg-success text-white">
                    <h5 class="mb-0">Bypass Branch</h5>
					<h5>Total Amount = @bypassCreditTotal</h5>
                </div>
                <div class="card-body">
                    @if (filteredBypassRecords.Any())
                    {
                        int sno = 1;
                        <table class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>S. No.</th>
                                    <th>Bill No</th>
                                    <th>Branch</th>
                                    <th>Customer Name</th>
                                    <th>Customer Mobile</th>
                                    <th>Credit Amount</th>
                                    <th>Paid Amount</th>
                                    <th>Remaining Balance</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in filteredBypassRecords)
                                {
                                    <tr style="cursor:pointer" @onclick="()=> CreditSelect(record.Customer)">
                                        <td>@(sno++)</td>
                                        <td>@record.BillNo</td>
                                        <td>@record.Branch</td>
                                        <td>@record.Customer.Name</td>
                                        <td>@record.Customer.Contact</td>
                                        <td>@record.CreditAmount</td>
                                        <td>@record.PaidAmount</td>
                                        <td>@record.RemainingBalance</td>
                                        <td>@record.DueDate</td>
                                        <td>@record.Status</td>
                                        <td>@record.CreatedAt</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center">No records for Bypass.</p>
                    }
                </div>
            </div>
        </div>
    }
</div>


@code {
    List<CreditRecord> records = new List<CreditRecord>();

    List<CreditRecord> sivakasiRecords = new List<CreditRecord>();
    List<CreditRecord> bypassRecords = new List<CreditRecord>();


    List<CreditRecord> filteredSivakasiRecords = new List<CreditRecord>();
    List<CreditRecord> filteredBypassRecords = new List<CreditRecord>();

    decimal sivakasiCreditTotal = 0m;
    decimal bypassCreditTotal = 0m;

    bool showSivakasi = true;
    bool showByPass = true;
    void FilterRecord(ChangeEventArgs e)
    {
        sivakasiCreditTotal = 0m;
		bypassCreditTotal = 0m;
        string text = e.Value.ToString();

        filteredSivakasiRecords = sivakasiRecords.Where(r =>
    r.Customer.Contact.Contains(text, StringComparison.OrdinalIgnoreCase) ||
    r.Customer.CustomerId.Contains(text, StringComparison.OrdinalIgnoreCase) ||
    r.Customer.Name.Contains(text, StringComparison.OrdinalIgnoreCase)
    ).ToList();

        filteredBypassRecords = bypassRecords.Where(r =>
    r.Customer.Contact.Contains(text, StringComparison.OrdinalIgnoreCase) ||
    r.Customer.CustomerId.Contains(text, StringComparison.OrdinalIgnoreCase) ||
    r.Customer.Name.Contains(text, StringComparison.OrdinalIgnoreCase)
    ).ToList();

		filteredSivakasiRecords.ForEach(s => sivakasiCreditTotal += s.CreditAmount);
		filteredBypassRecords.ForEach(b => bypassCreditTotal += b.CreditAmount);
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        await FetchData();
        StateHasChanged();
    }
    public void CreditSelect(UserModal data)
    {
        CurrentData.Set(CurrentType.Customer, data);
        Navigation.NavigateTo("/view/credit-customer");
    }
    public async Task FetchData()
    {
        sivakasiCreditTotal = 0m;
		bypassCreditTotal = 0m;
        string fetchQuery = "SELECT c.*,cu.*,b.* FROM CreditRecord c JOIN Customers cu ON c.CustomerID = cu.CustomerID LEFT JOIN Bills b ON c.BillID = b.BillID";

        var result = await DatabaseHandler.ExecuteQueryAsync(fetchQuery);
        if (result.Count > 0)
        {

            var groupedRecords = result
                .GroupBy(row => row["CustomerID"].ToString())  // Group by CustomerID
                .Select(group => new CreditRecord
                    {
                        CustomerID = group.Key,  // Group key is the CustomerID
                        BillNo = group.FirstOrDefault()?["BillNo"].ToString(),
                        Branch = group.FirstOrDefault()?["Branch"].ToString(),
                        CreditAmount = group.Sum(row => Convert.ToDecimal(row["CreditAmount"])),  // Sum of CreditAmount
                        PaidAmount = group.Sum(row => Convert.ToDecimal(row["PaidAmount"])),  // Sum of PaidAmount
                        RemainingBalance = group.Sum(row => Convert.ToDecimal(row["RemainingBalance"] ?? 0)),  // Sum of RemainingBalance
                        DueDate = group.FirstOrDefault()?["DueDate"] == DBNull.Value ? DateTime.MinValue : Convert.ToDateTime(group.FirstOrDefault()?["DueDate"]),
                        Status = group.FirstOrDefault()?["Status"].ToString(),
                        CreatedAt = group.FirstOrDefault()?["CreatedAt"] == DBNull.Value ? DateTime.MinValue : Convert.ToDateTime(group.FirstOrDefault()?["CreatedAt"]),
                        Customer = new UserModal
                        {
                            CustomerId = group.Key,
                            Name = group.FirstOrDefault()?["Name"].ToString() ?? "",
                            Contact = group.FirstOrDefault()?["Contact"].ToString() ?? "",
                            GSTIN = group.FirstOrDefault()?["GSTIN"].ToString() ?? "",
                            Address = group.FirstOrDefault()?["Address"].ToString() ?? "",
                            Area = group.FirstOrDefault()?["Area"].ToString() ?? "",
                            City = group.FirstOrDefault()?["City"].ToString() ?? "",
                            State = group.FirstOrDefault()?["State"].ToString() ?? "",
                            Country = group.FirstOrDefault()?["Country"].ToString() ?? "",
                            District = group.FirstOrDefault()?["District"].ToString() ?? "",
                            Nationality = group.FirstOrDefault()?["Nationality"].ToString() ?? "",
                            PinCode = group.FirstOrDefault()?["PinCode"].ToString() ?? "",
                            Website = group.FirstOrDefault()?["Website"].ToString() ?? "",
                            Email = group.FirstOrDefault()?["Email"].ToString() ?? "",
                        }
                    }).ToList(); // Convert grouped data to list

            records = groupedRecords;
        }
        sivakasiRecords = records.Where(r => r.Branch.ToLower() == "sivakasi").ToList();
        bypassRecords = records.Where(r => r.Branch.ToLower() == "bypass").ToList();
        filteredSivakasiRecords = sivakasiRecords;
        filteredBypassRecords = bypassRecords;

        filteredSivakasiRecords.ForEach(s => sivakasiCreditTotal += s.CreditAmount);
		filteredBypassRecords.ForEach(b => bypassCreditTotal += b.CreditAmount);
    }


    public void UpdateProduct(BrandType data)
    {
        CurrentData.Set(CurrentType.Brand,data);
        Navigation.NavigateTo("/brand/update");
    }

    public async Task DeleteProduct(string brandID)
    {
        string deleteQuery = $"DELETE FROM Brands WHERE BrandID = {brandID}";

        await DatabaseHandler.ExecuteQueryAsync(deleteQuery);
    }
}